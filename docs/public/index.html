<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Adjusted ROIC Index — AI Capital Productivity Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0e17;
  --surface: #111827;
  --surface-2: #1a2235;
  --border: #2a3450;
  --text: #e2e8f0;
  --text-dim: #8994a7;
  --accent-t1: #f97316;
  --accent-t2: #06b6d4;
  --accent-avg: #a78bfa;
  --accent-wcap: #fbbf24;
  --positive: #34d399;
  --negative: #f87171;
  --font: 'DM Sans', -apple-system, sans-serif;
  --mono: 'JetBrains Mono', monospace;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { background:var(--bg); color:var(--text); font-family:var(--font); line-height:1.6; }
.container { max-width:1400px; margin:0 auto; padding:0 24px; }

header { border-bottom:1px solid var(--border); padding:28px 0 20px; }
header .container { display:flex; justify-content:space-between; align-items:flex-end; flex-wrap:wrap; gap:12px; }
.logo h1 { font-size:20px; font-weight:700; letter-spacing:-0.5px; }
.logo span { font-size:11px; color:var(--text-dim); text-transform:uppercase; letter-spacing:2px; }
.meta { text-align:right; font-size:11px; color:var(--text-dim); font-family:var(--mono); }

/* KPI strip */
.kpi-strip { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; padding:24px 0 16px; }
.kpi { background:var(--surface); border:1px solid var(--border); border-radius:6px; padding:16px; position:relative; overflow:hidden; }
.kpi::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; }
.kpi.t1::before { background:var(--accent-t1); }
.kpi.t2::before { background:var(--accent-t2); }
.kpi.avg::before { background:var(--accent-avg); }
.kpi.gap::before { background:linear-gradient(90deg,var(--accent-t1),var(--accent-t2)); }
.kpi-label { font-size:10px; color:var(--text-dim); text-transform:uppercase; letter-spacing:1.2px; margin-bottom:4px; }
.kpi-value { font-size:28px; font-weight:700; font-family:var(--mono); }
.kpi-sub { font-size:11px; color:var(--text-dim); margin-top:2px; }

/* Main chart */
.chart-section { padding:8px 0 20px; }
.chart-card { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:20px; margin-bottom:20px; }
.chart-card h2 { font-size:14px; font-weight:600; margin-bottom:4px; }
.chart-card .subtitle { font-size:11px; color:var(--text-dim); margin-bottom:16px; }
.chart-wrap { position:relative; height:440px; }

/* Company toggles */
.co-toggles { margin-bottom:16px; }
.co-toggles-label { font-size:11px; color:var(--text-dim); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
.co-group { display:flex; flex-wrap:wrap; gap:5px; margin-bottom:8px; }
.co-group-label { font-size:10px; color:var(--text-dim); text-transform:uppercase; letter-spacing:1px; width:100%; margin-bottom:2px; }
.co-chip {
  padding:3px 10px; border-radius:3px; font-size:11px; font-family:var(--mono);
  cursor:pointer; transition:all 0.12s; border:1px solid var(--border); background:transparent; color:var(--text-dim);
  user-select:none;
}
.co-chip:hover { border-color:var(--text-dim); color:var(--text); }
.co-chip.active { color:#000; font-weight:500; }
.co-chip.t1.active { background:var(--accent-t1); border-color:var(--accent-t1); }
.co-chip.t2.active { background:var(--accent-t2); border-color:var(--accent-t2); }
.toggle-actions { display:flex; gap:8px; margin-bottom:10px; }
.toggle-actions button {
  background:var(--surface-2); border:1px solid var(--border); color:var(--text-dim);
  padding:4px 12px; border-radius:3px; font-size:10px; cursor:pointer; font-family:var(--font);
  text-transform:uppercase; letter-spacing:0.5px;
}
.toggle-actions button:hover { color:var(--text); border-color:var(--text-dim); }

/* Table */
.scoreboard { padding:20px 0 40px; }
.scoreboard h2 { font-size:14px; font-weight:600; margin-bottom:12px; }
table { width:100%; border-collapse:collapse; font-size:12px; }
th { text-align:left; padding:8px 10px; font-size:10px; text-transform:uppercase; letter-spacing:0.8px; color:var(--text-dim); border-bottom:1px solid var(--border); cursor:pointer; white-space:nowrap; }
th:hover { color:var(--text); }
td { padding:8px 10px; border-bottom:1px solid rgba(42,52,80,0.4); font-family:var(--mono); font-size:11px; }
td:first-child { font-family:var(--font); font-weight:500; }
tr:hover { background:var(--surface-2); }
.tier-badge { display:inline-block; padding:1px 6px; border-radius:2px; font-size:9px; font-weight:600; letter-spacing:0.5px; }
.tier-badge.t1 { background:rgba(249,115,22,0.15); color:var(--accent-t1); }
.tier-badge.t2 { background:rgba(6,182,212,0.15); color:var(--accent-t2); }
.val-pos { color:var(--positive); } .val-neg { color:var(--negative); }

/* Gap chart */
.gap-chart-wrap { height:220px; position:relative; }

/* Methodology */
.methodology { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:20px; margin:0 0 24px; font-size:12px; color:var(--text-dim); line-height:1.8; }
.methodology h3 { color:var(--text); font-size:13px; margin-bottom:8px; }

footer { border-top:1px solid var(--border); padding:20px 0; text-align:center; font-size:10px; color:var(--text-dim); }

@media (max-width:768px) { .chart-wrap { height:300px; } .kpi-value { font-size:22px; } }
</style>
</head>
<body>

<header>
  <div class="container">
    <div class="logo">
      <h1>Adjusted ROIC Index</h1>
      <span>AI Capital Productivity Tracker · Intentional Futures</span>
    </div>
    <div class="meta">
      <div id="update-date">Loading…</div>
      <div id="quarter-label"></div>
    </div>
  </div>
</header>

<main class="container">
  <section class="kpi-strip" id="kpi-strip"></section>

  <section class="chart-section">
    <div class="chart-card">
      <h2>Adjusted ROIC: Aggregate Trends with Company Overlay</h2>
      <div class="subtitle">Aggregate lines always shown. Toggle individual companies to compare against the index.</div>

      <div class="co-toggles">
        <div class="toggle-actions">
          <button onclick="toggleAll(1)">All Tier 1</button>
          <button onclick="toggleAll(2)">All Tier 2</button>
          <button onclick="clearAll()">Clear All</button>
        </div>
        <div class="co-group" id="t1-chips">
          <div class="co-group-label">Tier 1 — AI Layoff Companies</div>
        </div>
        <div class="co-group" id="t2-chips">
          <div class="co-group-label">Tier 2 — Control Group</div>
        </div>
      </div>

      <div class="chart-wrap"><canvas id="main-chart"></canvas></div>
    </div>

    <div class="chart-card">
      <h2>ROIC Gap: AI Layoff Tier − Control Tier</h2>
      <div class="subtitle">Positive = AI layoff companies outperforming. Negative = control group ahead.</div>
      <div class="gap-chart-wrap"><canvas id="gap-chart"></canvas></div>
    </div>
  </section>

  <section class="scoreboard">
    <h2>Current Quarter Scoreboard</h2>
    <table>
      <thead><tr>
        <th data-sort="name">Company</th>
        <th data-sort="ticker">Ticker</th>
        <th data-sort="tier">Tier</th>
        <th data-sort="sector">Sector</th>
        <th data-sort="adj_roic">Adj ROIC</th>
        <th data-sort="reported_roic">Reported</th>
        <th data-sort="spread">Spread</th>
        <th data-sort="rev_per_employee">Rev/Emp</th>
      </tr></thead>
      <tbody id="scoreboard-body"></tbody>
    </table>
  </section>

  <div class="methodology" id="methodology"></div>
</main>

<footer><div class="container">
  Data: SEC EDGAR XBRL · Analysis: Intentional Futures · Draft — validate against primary filings
</div></footer>

<script>
let DATA = null;
let mainChart = null;
let activeCompanies = new Set();

// Color palette for individual companies
const CO_COLORS = [
  '#ef4444','#f97316','#eab308','#22c55e','#14b8a6','#06b6d4','#3b82f6','#6366f1',
  '#8b5cf6','#a855f7','#d946ef','#ec4899','#f43f5e','#fb923c','#a3e635','#2dd4bf',
  '#38bdf8','#818cf8','#c084fc','#f472b6','#fb7185','#fdba74','#bef264','#5eead4',
  '#7dd3fc','#a5b4fc'
];

function fmtPct(v,d=1) { return v==null?'—':(v*100).toFixed(d)+'%'; }
function fmtNum(v) { return v==null?'—':Math.round(v).toLocaleString(); }

async function init() {
  const resp = await fetch('data.json');
  DATA = await resp.json();
  document.getElementById('update-date').textContent = 'Updated ' + new Date(DATA.generated).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  document.getElementById('quarter-label').textContent = DATA.current_quarter;
  renderKPIs();
  buildChips();
  renderMainChart();
  renderGapChart();
  renderScoreboard();
  renderMethodology();
}

function renderKPIs() {
  const q = DATA.current_quarter;
  const t1=DATA.indices.tier1[q], t2=DATA.indices.tier2[q], all=DATA.indices.all[q], gap=DATA.indices.gap[q];

  // Calculate equal-weight average
  let sum=0, cnt=0;
  DATA.scoreboard.forEach(c => { if(c.adj_roic!=null){sum+=c.adj_roic;cnt++;}});
  const avg = cnt>0 ? sum/cnt : null;

  document.getElementById('kpi-strip').innerHTML = [
    {l:'Tier 1 · Mkt-Cap Wtd',v:fmtPct(t1),cls:'t1',s:'16 AI layoff companies'},
    {l:'Tier 2 · Mkt-Cap Wtd',v:fmtPct(t2),cls:'t2',s:'10 control companies'},
    {l:'Equal-Weight Average',v:fmtPct(avg),cls:'avg',s:'All 26 companies'},
    {l:'Tier Gap',v:gap!=null?(gap>=0?'+':'')+fmtPct(gap):'—',cls:'gap',s:'AI Layoff − Control'},
  ].map(k=>`<div class="kpi ${k.cls}"><div class="kpi-label">${k.l}</div><div class="kpi-value">${k.v}</div><div class="kpi-sub">${k.s}</div></div>`).join('');
}

function buildChips() {
  const t1el = document.getElementById('t1-chips');
  const t2el = document.getElementById('t2-chips');
  // Keep the group labels
  const t1label = t1el.querySelector('.co-group-label').outerHTML;
  const t2label = t2el.querySelector('.co-group-label').outerHTML;
  t1el.innerHTML = t1label;
  t2el.innerHTML = t2label;

  DATA.scoreboard.forEach((c,i) => {
    const chip = document.createElement('div');
    chip.className = `co-chip t${c.tier}`;
    chip.textContent = c.ticker;
    chip.dataset.ticker = c.ticker;
    chip.dataset.tier = c.tier;
    chip.addEventListener('click', () => toggleCompany(c.ticker, chip));
    (c.tier===1 ? t1el : t2el).appendChild(chip);
  });
}

function toggleCompany(ticker, chip) {
  if (activeCompanies.has(ticker)) {
    activeCompanies.delete(ticker);
    chip.classList.remove('active');
  } else {
    activeCompanies.add(ticker);
    chip.classList.add('active');
  }
  renderMainChart();
}

function toggleAll(tier) {
  const chips = document.querySelectorAll(`.co-chip.t${tier}`);
  const tickers = [...chips].map(c=>c.dataset.ticker);
  const allActive = tickers.every(t=>activeCompanies.has(t));
  tickers.forEach(t => { if(allActive) activeCompanies.delete(t); else activeCompanies.add(t); });
  chips.forEach(c => c.classList.toggle('active', !allActive));
  renderMainChart();
}

function clearAll() {
  activeCompanies.clear();
  document.querySelectorAll('.co-chip').forEach(c=>c.classList.remove('active'));
  renderMainChart();
}

function renderMainChart() {
  if (mainChart) mainChart.destroy();
  const qs = DATA.quarters;

  // Calculate equal-weight average per quarter
  const eqAvg = qs.map(q => {
    let s=0,n=0;
    DATA.scoreboard.forEach(c => {
      // Find this company's ROIC for this quarter from indices data
      // For public view, we only have scoreboard (current quarter) — use indices instead
    });
    return null; // We'll compute from internal if available
  });

  // Build datasets: always show the 3 aggregate lines
  const datasets = [
    {
      label: 'Tier 1: AI Layoff (Mkt-Cap Wtd)',
      data: qs.map(q => DATA.indices.tier1[q] || null),
      borderColor: '#f97316',
      backgroundColor: 'rgba(249,115,22,0.06)',
      borderWidth: 3,
      fill: true,
      tension: 0.3,
      pointRadius: 0,
      pointHoverRadius: 5,
      order: 1,
    },
    {
      label: 'Tier 2: Control (Mkt-Cap Wtd)',
      data: qs.map(q => DATA.indices.tier2[q] || null),
      borderColor: '#06b6d4',
      borderWidth: 3,
      borderDash: [8,4],
      fill: false,
      tension: 0.3,
      pointRadius: 0,
      pointHoverRadius: 5,
      order: 1,
    },
    {
      label: 'All 26 (Mkt-Cap Wtd)',
      data: qs.map(q => DATA.indices.all[q] || null),
      borderColor: '#a78bfa',
      borderWidth: 2,
      borderDash: [3,3],
      fill: false,
      tension: 0.3,
      pointRadius: 0,
      pointHoverRadius: 5,
      order: 1,
    },
  ];

  // Add individual company lines for active selections
  // For public view with internal data structure
  let coIdx = 0;
  activeCompanies.forEach(ticker => {
    const co = DATA.companies ? DATA.companies[ticker] : null;
    let coData;
    if (co) {
      // Internal data — has full quarterly detail
      coData = qs.map(q => co.quarters[q] ? co.quarters[q].adj_roic : null);
    } else {
      // Public-only — we don't have per-quarter company data
      // Show just current quarter as annotation
      const sb = DATA.scoreboard.find(s=>s.ticker===ticker);
      coData = qs.map((q,i) => i===qs.length-1 && sb ? sb.adj_roic : null);
    }
    const color = CO_COLORS[coIdx % CO_COLORS.length];
    datasets.push({
      label: ticker,
      data: coData,
      borderColor: color,
      borderWidth: 1.5,
      fill: false,
      tension: 0.3,
      pointRadius: 0,
      pointHoverRadius: 4,
      order: 2,
    });
    coIdx++;
  });

  const ctx = document.getElementById('main-chart').getContext('2d');
  mainChart = new Chart(ctx, {
    type: 'line',
    data: { labels: qs, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: '#8994a7',
            font: { family: 'DM Sans', size: 11 },
            usePointStyle: true,
            pointStyle: 'line',
            padding: 16,
          }
        },
        tooltip: {
          backgroundColor: '#1a2235',
          borderColor: '#2a3450',
          borderWidth: 1,
          titleFont: { family: 'DM Sans', size: 12 },
          bodyFont: { family: 'JetBrains Mono', size: 11 },
          callbacks: { label: ctx => ctx.dataset.label + ': ' + fmtPct(ctx.parsed.y) }
        }
      },
      scales: {
        x: {
          ticks: { color:'#8994a7', font:{size:9}, maxRotation:45, autoSkip:true, maxTicksLimit:16 },
          grid: { color:'rgba(42,52,80,0.3)' }
        },
        y: {
          ticks: { color:'#8994a7', callback:v=>fmtPct(v,0) },
          grid: { color:'rgba(42,52,80,0.3)' }
        }
      }
    }
  });
}

function renderGapChart() {
  const qs = DATA.quarters;
  const gapData = qs.map(q => DATA.indices.gap[q] || null);
  new Chart(document.getElementById('gap-chart').getContext('2d'), {
    type:'bar',
    data:{ labels:qs, datasets:[{
      data:gapData,
      backgroundColor:gapData.map(v => v!=null&&v>=0 ? 'rgba(249,115,22,0.5)' : 'rgba(6,182,212,0.5)'),
      borderWidth:0,
    }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{display:false}, tooltip:{callbacks:{label:ctx=>'Gap: '+fmtPct(ctx.parsed.y)}} },
      scales:{
        x:{ticks:{color:'#8994a7',font:{size:9},maxTicksLimit:16},grid:{display:false}},
        y:{ticks:{color:'#8994a7',callback:v=>fmtPct(v,0)},grid:{color:'rgba(42,52,80,0.3)'}}
      }
    }
  });
}

function renderScoreboard() {
  let rows = [...DATA.scoreboard];
  let sortCol='adj_roic', sortAsc=false;

  function render() {
    rows.sort((a,b) => {
      let va=a[sortCol]??-Infinity, vb=b[sortCol]??-Infinity;
      if(typeof va==='string') return sortAsc?va.localeCompare(vb):vb.localeCompare(va);
      return sortAsc?va-vb:vb-va;
    });
    document.getElementById('scoreboard-body').innerHTML = rows.map(r=>`
      <tr>
        <td>${r.name}</td>
        <td style="font-size:10px">${r.ticker}</td>
        <td><span class="tier-badge t${r.tier}">${r.tier===1?'AI LAYOFF':'CONTROL'}</span></td>
        <td style="color:var(--text-dim);font-family:var(--font)">${r.sector}</td>
        <td class="${(r.adj_roic||0)>=0?'val-pos':'val-neg'}">${fmtPct(r.adj_roic)}</td>
        <td>${fmtPct(r.reported_roic)}</td>
        <td class="${(r.spread||0)>=0?'val-pos':'val-neg'}">${fmtPct(r.spread)}</td>
        <td>${r.rev_per_employee?'$'+fmtNum(r.rev_per_employee)+'K':'—'}</td>
      </tr>
    `).join('');
  }

  document.querySelectorAll('th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
      if(sortCol===th.dataset.sort) sortAsc=!sortAsc; else { sortCol=th.dataset.sort; sortAsc=false; }
      render();
    });
  });
  render();
}

function renderMethodology() {
  const m = DATA.methodology_summary;
  if(!m) return;
  document.getElementById('methodology').innerHTML = `
    <h3>Methodology</h3>
    <p><strong>Tier 1:</strong> ${m.tier1_description}</p>
    <p><strong>Tier 2:</strong> ${m.tier2_description}</p>
    <p style="margin-top:8px"><strong>Adjustments:</strong> ${m.adjustments.join(' · ')}</p>
    <p><strong>Annualization:</strong> ${m.annualization}</p>
  `;
}

init();
</script>
</body>
</html>
